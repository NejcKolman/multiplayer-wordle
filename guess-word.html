<html>

<head>
    <link rel="stylesheet" href="css/landing.css" />
    <link rel="stylesheet" href="css/guess.css" />
</head>

<body>
    <input type="text" id="myGuess" autofocus onchange="guess()" minlength="5" maxlength="5" placeholder="guess">
    <span id="result"></span>

    <p id="warning"></p>


    <table id='guesses'>


    </table>

    <script>


        async function fetchWords(language) {
            let response = await fetch("data/besede/" + language + ".txt")
            let words = await response.text()
            return words.toUpperCase().split('\n')
        }
        let ALL_WORDS = fetchWords("eng")
        let VSE_BESEDE = fetchWords("slo")




        const params = new URLSearchParams(window.location.search)
        encoded = params.get('beseda')
        toGuess = unescape(atob(encoded)).toUpperCase()
        language = params.get('language')
        //display:none; block
        function guess() {
            myGuess = document.getElementById("myGuess").value.toUpperCase()
            if (language == 'eng' && ALL_WORDS.includes(myGuess) == false) {
                document.getElementById('warning').innerHTML = 'The word is not in the word list!'
                return
            }
            if (language == 'slo' && VSE_BESEDE.includes(myGuess) == false) {
                document.getElementById('warning').innerHTML = 'Besede ni v seznamu besed!'
                return
            }
            console.log(myGuess)
            if (myGuess.length != 5) {
                document.getElementById('warning').innerHTML = 'Beseda mora imeti 5 ƒçrk!'
                return
            }
            document.getElementById('warning').innerHTML = ''


            const matchingLetters = getMatches(myGuess, toGuess)
            showNewGuessRow(matchingLetters)


        }


        function getMatches(myGuess, toGuess) {
            let greenLetters = {}
            let greyLetters = {}
            let yellowLetters = {}
            let unguessed = {}
            for (let i = 0; i < 5; i++) {
                let letter = myGuess[i]
                if (letter == toGuess[i]) {
                    greenLetters[i] = letter

                } else if (toGuess.includes(letter) == false) {
                    greyLetters[i] = letter
                    unguessed[i] = toGuess[i]
                } else { unguessed[i] = toGuess[i] }

            }

            for (let i = 0; i < 5; i++) {

                let letter = myGuess[i]
                if (i in greenLetters || i in greyLetters) {
                    continue
                }
                console.log(i)
                let isYellow = false
                console.log(unguessed)
                for (const [key, value] of Object.entries(unguessed)) {
                    if (value == letter && isYellow == false) {
                        yellowLetters[i] = letter
                        delete unguessed[key]
                        isYellow = true
                    }
                }

                if (isYellow == false) {
                    greyLetters[i] = letter
                }
            }


            return [greenLetters, greyLetters, yellowLetters]
        }

        function showNewGuessRow(matchingLetters) {
            let [greenLetters, greyLetters, yellowLetters] = matchingLetters
            let tr = document.createElement('tr')

            for (let i = 0; i < 5; i++) {
                let td = document.createElement('td')
                if (i in greenLetters) {
                    td.append(greenLetters[i])
                    td.className = 'correct'
                } else if (i in greyLetters) {
                    td.append(greyLetters[i])
                    td.className = 'wrong'
                } else {
                    td.append(yellowLetters[i])
                    td.className = 'partial'
                }

                tr.append(td)

            }
            document.getElementById('guesses').append(tr)
        }




    </script>
</body>

</html>