<html>

<head>
    <link rel="stylesheet" href="css/landing.css" />
    <link rel="stylesheet" href="css/guess.css" />
</head>

<body>
    <input type="text" id="myGuess" autofocus onchange="guess()" minlength="5" maxlength="5" placeholder="guess">
    <span id="result"></span>

    <p id="warning"></p>

    <button id='clipboard' onclick="copyToClipBoard()" style="display: none">Copy to clipboard</button>
    <table id='guesses'>


    </table>


    <textarea id="myTextarea" style="display: none">

    </textarea>

    <script>


        async function fetchWords(language) {
            let response = await fetch("data/besede/" + language + ".txt")
            let words = await response.text()
            return words.split('\n')
        }
        let ALL_WORDS = []
        let VSE_BESEDE = []
        async function preloadWords() {
            const word_lists = await Promise.all([fetchWords("slo"), fetchWords("eng")]);
            VSE_BESEDE = word_lists[0];
            ALL_WORDS = word_lists[1];
        }
        preloadWords()




        const params = new URLSearchParams(window.location.search)
        encoded = params.get('beseda')
        toGuess = unescape(atob(encoded)).toUpperCase()
        language = params.get('language')
        //display:none; block
        function guess() {
            myGuess = document.getElementById("myGuess").value.toUpperCase()
            if (language == 'eng' && ALL_WORDS.includes(myGuess.toLowerCase()) == false) {
                document.getElementById('warning').innerHTML = 'The word is not in the word list!'
                return
            }
            if (language == 'slo' && VSE_BESEDE.includes(myGuess.toLowerCase()) == false) {
                document.getElementById('warning').innerHTML = 'Besede ni v seznamu besed!'
                return
            }
            console.log(myGuess)
            if (myGuess.length != 5) {
                document.getElementById('warning').innerHTML = 'Beseda mora imeti 5 ƒçrk!'
                return
            }
            document.getElementById('warning').innerHTML = ''


            const matchingLetters = getMatches(myGuess, toGuess)
            showNewGuessRow(matchingLetters)
            document.getElementById('myGuess').value = ""


        }

        let all_guesses = ''
        function getMatches(myGuess, toGuess) {
            let greenLetters = {}
            let greyLetters = {}
            let yellowLetters = {}
            let unguessed = {}
            for (let i = 0; i < 5; i++) {
                let letter = myGuess[i]
                if (letter == toGuess[i]) {
                    greenLetters[i] = letter

                } else if (toGuess.includes(letter) == false) {
                    greyLetters[i] = letter
                    unguessed[i] = toGuess[i]
                } else { unguessed[i] = toGuess[i] }

            }

            for (let i = 0; i < 5; i++) {

                let letter = myGuess[i]
                if (i in greenLetters || i in greyLetters) {
                    continue
                }
                console.log(i)
                let isYellow = false
                console.log(unguessed)
                for (const [key, value] of Object.entries(unguessed)) {
                    if (value == letter && isYellow == false) {
                        yellowLetters[i] = letter
                        delete unguessed[key]
                        isYellow = true
                    }
                }

                if (isYellow == false) {
                    greyLetters[i] = letter
                }
            }


            return [greenLetters, greyLetters, yellowLetters]
        }

        function showNewGuessRow(matchingLetters) {
            let [greenLetters, greyLetters, yellowLetters] = matchingLetters
            let tr = document.createElement('tr')

            for (let i = 0; i < 5; i++) {
                let td = document.createElement('td')
                if (i in greenLetters) {
                    td.append(greenLetters[i])
                    td.className = 'correct'
                    all_guesses += 'Z'//üü©
                } else if (i in greyLetters) {
                    td.append(greyLetters[i])
                    td.className = 'wrong'
                    all_guesses += 'S'//‚¨ú
                } else {
                    td.append(yellowLetters[i])
                    td.className = 'partial'
                    all_guesses += 'R'//üü®
                }

                tr.append(td)




            }
            if (all_guesses.includes('ZZZZZ')) {
                console.log('here')
                correctGuess()
            }
            all_guesses += '-'
            document.getElementById('guesses').append(tr)
        }

        function correctGuess() {
            document.getElementById('clipboard').removeAttribute('style')
        }
        function copyToClipBoard() {
            document.getElementById('myTextarea').removeAttribute('style')
            document.getElementById('myTextarea').value = all_guesses
            var content = document.getElementById('myTextarea');

            content.select();
            document.execCommand('copy');

            alert("Copied to clipboard");
        }


    </script>
</body>

</html>